# Validates ArgoCD Application and AppProject manifests against their
# schema definitions.

name: Validate ArgoCD Schema

on:
  pull_request:
    paths:
      - 'argocd-apps/**/*.yaml'
      - 'argocd-apps/**/*.yml'
  push:
    branches:
      - main
    paths:
      - 'argocd-apps/**/*.yaml'
      - 'argocd-apps/**/*.yml'
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate-schema:
    name: Validate ArgoCD Manifest Schemas
    runs-on: ubuntu-24.04
    timeout-minutes: 5

    env:
      KUBECONFORM_VERSION: v0.7.0
      KUBECONFORM_SHA256: c31518ddd122663b3f3aa874cfe8178cb0988de944f29c74a0b9260920d115d3
      K8S_SCHEMA_VERSION: "1.33.0"

    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955

      - name: Download kubeconform
        run: |
          set -euo pipefail
          curl -sSfL --retry 3 --retry-delay 2 -o /tmp/kubeconform.tar.gz \
            https://github.com/yannh/kubeconform/releases/download/${KUBECONFORM_VERSION}/kubeconform-linux-amd64.tar.gz
          echo "${KUBECONFORM_SHA256}  /tmp/kubeconform.tar.gz" | sha256sum -c
          tar -xzf /tmp/kubeconform.tar.gz -C /tmp
          chmod +x /tmp/kubeconform
          /tmp/kubeconform -v

      - name: Validate ArgoCD manifests
        run: |
          set -euo pipefail
          /tmp/kubeconform \
            -strict \
            -summary \
            -output text \
            -kubernetes-version ${K8S_SCHEMA_VERSION} \
            -schema-location default \
            -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json' \
            argocd-apps/
          echo "âœ… kubeconform validation passed for argocd-apps/ (k8s=${K8S_SCHEMA_VERSION})" >> "$GITHUB_STEP_SUMMARY"
